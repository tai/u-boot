/*
 * Description:
 * 		Fronpannel led show implementation, reference to
 * 		kernel driver.
 *
 * Author: Celestial
 */
#include <common.h>
#include <command.h>

/*************************************************************
 FPC_INIT
 Description: Boot with a default sign on fpc led.
 	      For a better interaction.
*************************************************************/

/* Register Map */
#define ORION_FPC_BASE          0x80172000

#define FPC_INTS                (0x00  >> 1) /* Interrupt Status Register */
#define FPC_INTM                (0x04  >> 1) /* Interrupt Mask Register */
#define FPC_RC_CTL_L            (0x08  >> 1) /* Remote Control Register */
#define FPC_RC_CMD_L            (0x100 >> 1) /* RC5 Command Register */
#define FPC_NEC_CMD_L           (0x104 >> 1) /* NEC Command Register */
#define FPC_LED_DATA_L          (0x200 >> 1) /* Led Display Data Register */
#define FPC_LED_CNTL_L          (0x204 >> 1) /* Led Display Control Register */
#define FPC_KSCAN_DATA_L        (0x300 >> 1) /* Key Scan Data Register */
#define FPC_KSCAN_CNTL_L        (0x304 >> 1) /* Key Scan Control Register */
#define FPC_ARBCNTL_L           (0x308 >> 1) /* Led & Key Scan Arbiter Control Register */
#define FPC_RC_CTL_H            (0x0a  >> 1) /* Remote Control Register */
#define FPC_RC_CMD_H            (0x102 >> 1) /* RC5 Command Register */
#define FPC_NEC_CMD_H           (0x106 >> 1) /* NEC Command Register */
#define FPC_LED_DATA_H          (0x202 >> 1) /* Led Display Data Register */
#define FPC_LED_CNTL_H          (0x206 >> 1) /* Led Display Control Register */
#define FPC_KSCAN_DATA_H        (0x302 >> 1) /* Key Scan Data Register */
#define FPC_KSCAN_CNTL_H        (0x306 >> 1) /* Key Scan Control Register */
#define FPC_ARBCNTL_H           (0x30a >> 1) /* Led & Key Scan Arbiter Control Register */


#define fpc_writew(v,a)         do { *((volatile unsigned short *)ORION_FPC_BASE + (a)) = v; }while(0)
#define fpc_readw(a)            *((volatile unsigned short  *)ORION_FPC_BASE + (a))

static unsigned char num_tab[] = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0x00 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0x10 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	/* */ /*!*/ /*"*/ /*#*/ /*$*/ /*%*/ /*&*/ /*'*/
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0x20 */
	/*(*/ /*)*/ /***/ /*+*/ /*,*/  /*-*/ /*.*/ /*/*/
	0x63, 0x0F, 0xff, 0xff, 0xff, 0xfd, 0xFE, 0xff,
	/*0*/ /*1*/ /*2*/ /*3*/ /*4*/ /*5*/ /*6*/ /*7*/
	0x03, 0x9f, 0x25, 0x0d, 0x99, 0x49, 0x41, 0x1f, /* 0x30 */
	/*8*/ /*9*/ /* */ /* */ /* */ /* */ /* */ /* */
	0x01, 0x09, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	/* */ /*A*/ /*B*/ /*C*/ /*D*/ /*E*/ /*F*/ /*G*/
	0xff, 0x11, 0x01, 0x63, 0x85, 0x61, 0x71, 0x09, /* 0x40 */
	/*H*/ /*I*/ /*J*/ /*K*/ /*L*/ /*M*/ /*N*/ /*O*/
	0x91, 0x9f, 0x87, 0xff, 0xe3, 0xff, 0x13, 0x03,
	/*P*/ /*Q*/ /*R*/ /*S*/ /*T*/ /*U*/ /*V*/ /*W*/
	0x31, 0x19, 0xF5, 0x49, 0xE1, 0x83, 0xff, 0xff, /* 0x50 */
	/*X*/ /*Y*/ /*Z*/ /*[*/ /*\*/ /*]*/ /*^*/ /*_*/
	0xff, 0x89, 0xff, 0x63, 0xff, 0x0F, 0xff, 0xEF,
	/*`*/ /*a*/ /*b*/ /*c*/ /*d*/ /*e*/ /*f*/ /*g*/
	0xff, 0x11, 0xC1, 0xE5, 0x85, 0x61, 0x71, 0x09, /* 0x60 */
	/*h*/ /*i*/  /*j*/ /*k*/ /*l*/ /*m*/ /*n*/ /*o*/
	0xD1, 0x9f, 0x87, 0xff, 0xe3, 0xff, 0xD5, 0xC5,
	/*p*/ /*q*/ /*r*/ /*s*/ /*t*/ /*u*/ /*v*/ /*w*/
	0x31, 0x19, 0xF5, 0x49, 0xE1, 0xC7, 0xff, 0xff, /* 0x70 */
	/*x*/ /*y*/ /*z*/ /*{*/ /*|*/ /*}*/ /*~*/ /* */
	0xff, 0x89, 0xff, 0xff, 0x9F, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0x80 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0x90 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xa0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xb0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xc0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xd0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xe0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, /* 0xf0 */
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};


void fpc_led_enable(int cmd)
{
	fpc_writew(0x8000, FPC_LED_CNTL_H);
	fpc_writew(0 != cmd ? 0x1000 : 0x0000, FPC_LED_CNTL_L);
}

void fpc_led_disp(int arg)
{
	fpc_writew((arg >> 16) & 0xffff, FPC_LED_DATA_H);
	fpc_writew(arg & 0xffff, FPC_LED_DATA_L);
}

void fpc_init_show(const char *string)
{
	int i, val;
	char  str[5] = { 0 };

	sprintf(str,"%-4s", string);

	for (val = 0, i = 0; i<4 ; i++)
		val |= num_tab[(int)str[i]] << (8 * i);

	fpc_led_disp(val);
	fpc_led_enable(1);
}

#define GPIO_PINMUX() do {}while(0)

int do_fpc_led (cmd_tbl_t *cmdtp, int flag, int argc, char *const argv[])
{
	 GPIO_PINMUX();
	 fpc_init_show(argv[1]);

	 return 0;
}

U_BOOT_CMD(
	fpcd,	CONFIG_SYS_MAXARGS/*5*/,	1,	do_fpc_led,
	"Display data on frontpanel led",
	"<data>"
	);

int do_fpcraw (cmd_tbl_t *cmdtp, int flag, int argc, char *const argv[])
{
	u32 val;

	val = simple_strtoul(argv[1], NULL, 16);

	GPIO_PINMUX();

	fpc_led_disp(val);
	fpc_led_enable(1);

	return 0;
}
int do_enagpio2(cmd_tbl_t *cmdtp, int flag, int argc, char *const argv[])
{
	fpc_writew(0x4000, FPC_LED_CNTL_H);
	fpc_writew(0x0000, FPC_LED_CNTL_L);
	return 0;
}

U_BOOT_CMD(
	fpcraw,	CONFIG_SYS_MAXARGS/*5*/,	1,	do_fpcraw,
	"Display raw data on frontpanel led",
	"<data>"
	);

U_BOOT_CMD(
	disled,	CONFIG_SYS_MAXARGS/*5*/,	1,	do_enagpio2,
	"Disable LED display and enable GPIO2",
	""
	);

